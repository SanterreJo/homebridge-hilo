<div class="card">
	<ol>
		<li>You will need to know the IP address or the domain name you use to connect to homebridge. Usually it will be the address in your browser</li>
		<li>Click on the button below to start the authentication process</li>
		<li>Login to your hilo account</li>
		<li>Enter the ip address or domain name you took not at step 1 and add the port 8880 at the end. Examples: http://192.168.0.10:8880 http://homebridge.local:8880</li>
		<li>Click on the "Save" button, then click on the "Link account" button</li>
		<li>You can save your config and restart your homebridge server</li>
	</ol>
	<button type="button" class="btn btn-primary" onclick="initiateAuth()">
		Login with Hilo
	</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/@badgateway/oauth2-client@2.3.0/browser/oauth2-client.min.js"></script>
<script>
	homebridge.showSchemaForm();
	async function initiateAuth() {
		const state = Math.random().toString(36).substring(7);
		const client = new OAuth2Client.OAuth2Client({
			server: "https://connexion.hiloenergie.com",
			clientId: "1ca9f585-4a55-4085-8e30-9746a65fa561",
			tokenEndpoint: "/HiloDirectoryB2C.onmicrosoft.com/B2C_1A_SIGN_IN/oauth2/v2.0/token",
			authorizationEndpoint:
				"/HiloDirectoryB2C.onmicrosoft.com/B2C_1A_SIGN_IN/oauth2/v2.0/authorize",
		});
		const codeVerifier = await OAuth2Client.generateCodeVerifier();

		const callback = homebridge.request('/callback', { codeVerifier });

		href = await client.authorizationCode.getAuthorizeUri({
			redirectUri: "https://my.home-assistant.io/redirect/oauth",
			codeVerifier,
			state,
			scope: [
				"openid",
				"https://HiloDirectoryB2C.onmicrosoft.com/hiloapis/user_impersonation",
				"offline_access",
			]
		});
		window.open(href, "_blank");
		
		const { refreshToken } = await callback;
		homebridge.toast.success("Successfully authenticated with Hilo");

		const refreshTokenInput = document.querySelector('input[name="refreshToken"]');
		refreshTokenInput.value = refreshToken;
	}
</script>
