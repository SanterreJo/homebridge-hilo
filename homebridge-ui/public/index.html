<div class="card">
	<button type="button" class="btn btn-primary" onclick="initiateAuth()">
		Login with Hilo
	</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/@badgateway/oauth2-client@2.3.0/browser/oauth2-client.min.js"></script>
<script>
	async function initiateAuth() {
		const state = Math.random().toString(36).substring(7);
		const client = new OAuth2Client.OAuth2Client({
			server: "https://connexion.hiloenergie.com",
			clientId: "1ca9f585-4a55-4085-8e30-9746a65fa561",
			tokenEndpoint: "/HiloDirectoryB2C.onmicrosoft.com/B2C_1A_SIGN_IN/oauth2/v2.0/token",
			authorizationEndpoint:
				"/HiloDirectoryB2C.onmicrosoft.com/B2C_1A_SIGN_IN/oauth2/v2.0/authorize",
		});
		const codeVerifier = await OAuth2Client.generateCodeVerifier();

		const callback = homebridge.request('/callback', { codeVerifier });

		href = await client.authorizationCode.getAuthorizeUri({
			redirectUri: "https://my.home-assistant.io/redirect/oauth",
			codeVerifier,
			state,
			scope: [
				"openid",
				"https://HiloDirectoryB2C.onmicrosoft.com/hiloapis/user_impersonation",
				"offline_access",
			]
		});
		window.open(href, "_blank");
		const { accessToken, refreshToken, expiresIn, refreshTokenExpiresIn } = await callback;
		let pluginConfigBlocks = await homebridge.getPluginConfig();
		pluginConfigBlocks = pluginConfigBlocks.map((block) => {
			block.accessToken = accessToken;
			block.refreshToken = refreshToken;
			block.expiresIn = expiresIn;
			block.refreshTokenExpiresIn = refreshTokenExpiresIn;
			return block;
		});
		await homebridge.updatePluginConfig(pluginConfigBlocks);
	}
</script>
